---
urugeas::version: '0.2.2'
# suppress running augool during augeas resource testing and vice versa
urugeas::exercise_tomcat_security_change: false
urugeas::exercise_augtool: true
# the shell command will be eventually embedded in a Jenkins job config.xml as CDATA section but here is it just a plain shell script
# so the ampersand, quotes, greater and less would be escaped
urugeas::shell_build_command: '# some curl command with output captured to $LOG_FILE'
urugeas::rest_command_payload_fragment:  |
  PAYLOAD=$(cat<<END|jq -c '.' | sed 's/"/\\"/g'
  {
    "repo": "${REPO}",
    "app" : "${APP}",
    "commands": [
      {
        "${SERVCE_NAME}": "stop",     
      }
    ],
    "filter": {
      "node": "${NODE}",
      "datacenter": "${DATCENTER}",
     }
  }
  echo "PAYLOAD=${PAYLOAD}" 
  END
  )

# NOTE: preserve a blank line above

urugeas::shell_command:  |
  MAX_RETRY= %{hiera('urugeas::max_retry')}
  TRY=$MAX_RETRY
  while [[ $TRY != 0 ]] ; do
    %{hiera('urugeas::shell_build_command')}
    grep -qiE "$ERROR_PATTERNS_REGEXP" $LOG_FILE > /dev/null
    ERROR_DETECTED=false
    if [[ $? -eq 0 ]]
    then
      ERROR_DETECTED=true
    fi
    if $ERROR_DETECTED
    then
      TRY=$(expr $TRY - 1)
      TRY_COUNT=$(expr $MAX_RETRY - $TRY)
      echo "ERROR: RETRY $TRY_COUNT"
    else
      TRY=0
    fi
  done

# NOTE: preserve a blank line above

uruseas::apache_log:  |
  {
    "@vips": [
      "%v"
    ],
    "@source": "%v%U%q",
    "@source_host": "%v",
    "@source_path": "%f",
    "@tags": [
      "Apache",
      "Access"
    ],
    "@message": "%h %l %u %t \"%r\" %>s %b",
    "@fields": {
      "timestamp": "%{%Y-%m-%dT%H:%M:%S%z}t",
      "clientip": "%a",
      "duration": "%D",
      "status": "%>s",
      "request": "%U%q",
      "urlpath": "%U",
      "urlquery": "%q",
      "method": "%m",
      "referer": "%{Referer}i",
      "user-agent": "%{User-agent}i",
      "bytes": "%B"
    }
  }

urugeas::dbuser: 'dbuser'
urugeas::command_template: "mysql -H ${HOST} -u %{hiera('urugeas::dbuser')} -D database -e \"query\""
urugeas::error_patterns:
  - 'end of file reached'
  - 'failed to generate additional resource'
  - 'encountered end of file'
  - 'failed to list packages'
  - 'retrieving certificate failed'

urugeas::fatal_error_patterns:
  - 'end of file reached'
  - 'failed to generate additional resource'
  - 'encountered end of file'
  - 'feiled to list packages'
  - 'retrieving certificate failed'

urugeas::augeas_testing:
  - set 'useSecurity/#text' 'false'
  - set 'port/#text' '8000'
  - set 'securityRealm/#attribute/class' 'example attribute'
  - insert 'test' before 'securityRealm/authContext' # add node
  - set 'securityRealm/test/#attribute/class' 'test class' # set attribute
  - set 'securityRealm/test/#text' 'test text' # set text
# - clear 'securityRealm/authContext' # this operation does not appear to work
# - rm 'securityRealm/authContext' # this will work, commented for exrcise

urugeas::tomcat_security_part1:
  - insert 'filter-mapping' before 'securityRealm/authContext'
  - set 'securityRealm/filter-mapping/filter-name/#text' 'httpHeaderSecurity'
  - set 'securityRealm/filter-mapping/url-pattern/#text' '/*'
  - set 'securityRealm/filter-mapping/dispatcher/#text' 'REQUEST'

urugeas::tomcat_security_part2:
  - insert 'filter' before 'securityRealm/authContext'
  - set 'securityRealm/filter/filter-name/#text' 'httpHeaderSecurity'
  - set 'securityRealm/filter/filter-class/#text' 'org.apache.catalina.filters.HttpHeaderSecurityFilter'
  - set 'securityRealm/filter/async-supported/#text' 'true'
  - insert 'init-param' after 'securityRealm/filter/async-supported'
  - set 'securityRealm/filter/init-param/param-name/#text' 'antiClickJackingEnabled'
  - set 'securityRealm/filter/init-param/param-value/#text' 'true'
  - insert 'init-param' after 'securityRealm/filter/async-supported'
  - set 'securityRealm/filter/init-param[1]/param-name/#text' 'antiClickJackingOption'
  - set 'securityRealm/filter/init-param[1]/param-value/#text' 'SAMEORIGIN'

urugeas::source_encoding: 'UTF-8'
urugeas::java_options:  |
  -Dfile.encoding=%{hiera('urugeas::source_encoding')} \
  -DAPP_LOG_ROOT=/var/log \

# NOTE: need a blank line above
