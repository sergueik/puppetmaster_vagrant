Info
----

One can bootstrap a standalone ruby environment to run [serverspec](http://serverspec.org/resource_types.html) .
with the help of [uru](https://bitbucket.org/jonforums/uru/wiki/Usage) on an internet-blocked Windows or Linux instance (uru is not the only option for Linux).

One could provision Uru environment from a zip/tar archive, one can also construct a Puppet module for the same.

The `$URU_HOME` home directory with Ruby runtime plus a handful of gems has the following structure:
```

+---.gem
+---reports
+---ruby
|   +---bin
...
+---spec
    +---local
```
![uru folder](https://raw.githubusercontent.com/sergueik/puppetmaster_vagrant/master/uru/screenshots/uru.png)

It has the following  gems and their dependencies installed:
```
rake 
rspec
rspec_junit_formatter
serverspec
winrm
```


Setup
-----

For windows, `uru.zip` can be created by installing `uru` on a machine with internet access, for example, on a developer host, 

For windows, Ruby is installed from MSI on a machine with internet access, then  
copied the Ruby installation directory of a Ruby installation into the `$URU_HOME` folder
and install all dependency gems:
```
uru.bat gem install --no-rdoc --no-ri serverspec specinfra winrm
```
finally  pack the directory.

On Linux, the tarball creation starts with compiling Ruby from source , with a prefix `${URU_HOME}/ruby`:
```
wget https://cache.ruby-lang.org/pub/ruby/2.1/ruby-2.1.9.tar.gz
tar xzvf ruby-2.1.9.tar.gz
yum groupinstall -y 'Developer Tools'
yum install -y zlib-devel openssl-devel
pushd ruby-2.1.9
./configure --prefix=/uru/ruby --disable-install-rdoc --disable-install-doc
make clean; make
sudo make install
```
then one switches to the isolated environment 
```
pushd $URU_HOME
wget https://bitbucket.org/jonforums/uru/downloads/uru-0.8.1-linux-x86.tar.gz
tar xzvf uru-0.8.1-linux-x86.tar.gz
./uru_rt admin add ruby/bin
./uru_rt ls
./uru_rt 219p490
```
and installs the required gem dependencies 
```
./uru_rt gem list
./uru_rt gem install --no-ri --no-rdoc rspec serverspec rake rspec_junit_formatter
cp -R ~/.gem .
```
With `$GEM_HOME` one can make sure gems are installed under `.gems` rather then the 
into a hidden `$HOME/.gem` directory (this may not work correctly, if there is an error, or if the command 

```
./uru_rt gem list --local --verbose
```
outputs the  different list of gems than expected, e.g. only the following gems are listed,
```
bigdecimal (1.2.4)
io-console (0.4.3)
json (1.8.1)
minitest (4.7.5)
psych (2.0.5)
rake (10.1.0)
rdoc (4.1.0)
test-unit (2.1.10.0)
```
copy the `.gem` directory to `$HOME`.

In the `spec` directory one places a trimmed down `windows_spec_helper.rb` and `spec_helper.rb`:
```
require 'serverspec'
set :backend, :cmd
```

and a stock Rakefile 
```
require 'rake'
require 'rspec/core/rake_task'

task :spec    => 'spec:all'
task :default => :spec

namespace :spec do
  targets = []
  Dir.glob('./spec/*').each do |dir|
    next unless File.directory?(dir)
    target = File.basename(dir)
    target = "_#{target}" if target == 'default'
    targets << target
  end

  task :all     => targets
  task :default => :all

  targets.each do |target|
    original_target = target == '_default' ? target[1..-1] : target
    desc "Run serverspec tests to #{original_target}"
    RSpec::Core::RakeTask.new(target.to_sym) do |t|
      ENV['TARGET_HOST'] = original_target
      t.rspec_opts = "--format documentation --format html --out reports/report_#{$host}.html --format json --out reports/report_#{$host}.json"
      t.pattern = "spec/#{original_target}/*_spec.rb"
    end
  end
end

```
that is generated by `serverspec init` with just one modification:
```
  t.rspec_opts = "--format documentation --format html --out reports/report_#{$host}.html --format json --out reports/report_#{$host}.json"
```
to enforce verbose formatted rspec result [logging](http://stackoverflow.com/questions/8785358/how-to-have-junitformatter-output-for-rspec-run-using-rake). 

The `local` directory can contain arbitrary number of domain-specific spec files, and a bootstrapper script which basically calls

on Windows
```
pushd c:/uru
uru_rt.exe admin add ruby\bin
$env:URU_INVOKER = 'powershell' 
uru_rt.exe ls
uru_rt.exe $tag 
uru_rt.exe ruby ${RubyPath}\lib\ruby\gems\${GEM_VERSION}\gems\rake-${RAKE_VERSION}\bin\rake spec
```


on Linux
```
#!/bin/sh
export URU_INVOKER=bash
pushd /uru
./uru_rt admin add ruby/bin
./uru_rt ls --verbose
TAG=$(./uru_rt  ls 2>& 1|awk -e '{print $1}')
./uru_rt $TAG
./uru_rt gem list
./uru_rt ruby ruby/lib/ruby/gems/2.1.0/gems/rake-10.1.0/bin/rake spec
```
The `uru` module contains a basic sample serverspec file that is run as a smoke test, but any real serverspec files can be dropped into the `local` folder and will run automatically.  During testing of the module, a number real serverspec files from existing LP modules have been put to the `uru` directory and run without errors.
All spec files should be put in the same directory, e.g. `spec\localhost`
```
require 'spec_helper'

describe port(3389) do
  it do 
   should be_listening.with('tcp') 
   should be_listening.with('udp') 
  end
end


describe file('c:/windows') do
  it { should be_directory }
end
```

The results are nicely formatted in a standalone HTML report:

![resultt](https://raw.githubusercontent.com/sergueik/puppetmaster_vagrant/master/uru/screenshots/result.png)

and json:
```
{
    "version": "3.5.0.beta4",
    "examples": [{
        "description": "should be directory",
        "full_description": "File \"c:/windows\" should be directory",
        "status": "passed",
        "file_path": "./spec/local/windows_spec.rb",
        "line_number": 4,
        "run_time": 0.470411,
        "pending_message": null
    }, {
        "description": "should be file",
        "full_description": "File \"c:/test\" should be file",
        "status": "failed",
        "file_path": "./spec/local/windows_spec.rb",
        "line_number": 8,
        "run_time": 0.545683,
        "pending_message": null,
        "exception": {
            "class": "RSpec::Expectations::ExpectationNotMetError",
            ...
        }
    }],
    "summary": {
        "duration": 1.054691,
        "example_count": 2,
        "failure_count": 1,
        "pending_count": 0
    },
    "summary_line": "2 examples, 1 failure"
}
```

One can easily parse the json and extract the `full_description` of failed tests and the  `summary_line`:
```
report_json = File.read('report_.json')
report_obj = JSON.parse(report_json)
report_obj['examples'].each do |example|
  if example['status'] !~ /passed/i
    pp [example['status'],example['full_description']]
  end
end
```
One can also print full json to stdout where it will be captured in `cloud-init.log`. 

See also [cucumberjs-junitxml](https://github.com/sonyschan/cucumberjs-junitxml)

Author
------
[Serguei Kouzmine](kouzmine_serguei@yahoo.com)
