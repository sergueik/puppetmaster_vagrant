Info
----

With the help of [uru](https://bitbucket.org/jonforums/uru/wiki/Usage) one can bootstrap a standalone ruby environment to run [serverspec](http://serverspec.org/resource_types.html) on Windows or Linux platform (uru is not the only option for Linux).
One could compose a zip with Ruby runtime plus a handful of gems on and explode it on the target instance. 
Next one would construct a Puppet module for the same.

The uru directory has the following structure:
```

+---reports
+---ruby
|   +---bin
|   +---include
|   |   +---ruby-2.1.0
|   |       +---ruby
|   |       |   +---backward
|   |       +---x64-mingw32
|   |           +---ruby
|   +---lib
|   |   +---pkgconfig
|   |   +---ruby
|   |       +---2.1.0
|   |       +---gems
|   |       |   +---2.1.0
|   |       |       +---cache
|   |       |       +---gems
|   |       |       +---specifications
|   |       |           +---default
|   |       +---site_ruby
|   |           +---2.1.0
|   +---share
|       +---man
|           +---man1
+---spec
    +---local
```
![uru folder](https://raw.githubusercontent.com/sergueik/puppetmaster_vagrant/master/uru/screenshots/uru.png)

It has the following  gems and their dependencies installed:
```
rake 
serverspec 
```

The `uru.zip` can be created by installing `uru` on a machine with internet access, for example, on a developer host, 

For windows, Ruby is installed from MSI, then  
copy the home directory of a Ruby installation under the `uru` folder and
and install all required gems via `uru.bat gem install serverspec specinfra winrm`, 
then pack the directory.

On Linux, the process is similar to provisioning the `.rvm` directory via tarball to an internet-disconnected Linux box. 
One builds ruby from source (rpm is not relocable), and installs it to `/uru/ruby` then switches to isolated environment and 
installs the required gem dependencies making sure gems are installed under `uru/ruby/lib/ruby/gems` rather then the 
into a hidden `.gem` directory.

In the `spec` directory one places a trimmed down `windows_spec_helper.rb` and `spec_helper.rb` both of which contain:
```
require 'serverspec'
set :backend, :cmd
```

and a stock Rakefile 
```
require 'rake'
require 'rspec/core/rake_task'

task :spec    => 'spec:all'
task :default => :spec

namespace :spec do
  targets = []
  Dir.glob('./spec/*').each do |dir|
    next unless File.directory?(dir)
    target = File.basename(dir)
    target = "_#{target}" if target == 'default'
    targets << target
  end

  task :all     => targets
  task :default => :all

  targets.each do |target|
    original_target = target == '_default' ? target[1..-1] : target
    desc "Run serverspec tests to #{original_target}"
    RSpec::Core::RakeTask.new(target.to_sym) do |t|
      ENV['TARGET_HOST'] = original_target
      t.rspec_opts = "--format documentation --format html --out reports/report_#{$host}.html --format json --out reports/report_#{$host}.json"
      t.pattern = "spec/#{original_target}/*_spec.rb"
    end
  end
end

```
that is generated by `serverspec init` with just one modification:
```
  t.rspec_opts = "--format documentation \
--format html --out reports/report_#{$host}.html \
 --format json --out reports/report_#{$host}.json"
```
to enforce verbose formatted rspec result [logging](http://stackoverflow.com/questions/8785358/how-to-have-junitformatter-output-for-rspec-run-using-rake). 

The `local` directory can contain arbitrary number of domain-specific spec files, and a bootstrapper script which basically calls

on Windows
```
pushd c:/uru
uru_rt.exe admin add ruby\bin
$env:URU_INVOKER = 'powershell' 
uru_rt.exe ls
uru_rt.exe $tag 
uru_rt.exe ruby ${RubyPath}\lib\ruby\gems\${GEM_VERSION}\gems\rake-${RAKE_VERSION}\bin\rake spec
```


on Linux
```
#!/bin/sh
export URU_INVOKER=bash
pushd /uru
./uru_rt admin add ruby/bin
./uru_rt ls --verbose
TAG=$(./uru_rt  ls 2>& 1|awk -e '{print $1}')
./uru_rt $TAG
./uru_rt gem list
./uru_rt ruby ruby/lib/ruby/gems/2.1.0/gems/rake-10.1.0/bin/rake spec
```
The `uru` module contains a basic sample serverspec file that is run as a smoke test, but any real serverspec files can be dropped into the `local` folder and will run automatically.  During testing of the module, a number real serverspec files from existing LP modules have been put to the `uru` directory and run without errors.
All spec files should be put in the same directory, e.g. `spec\localhost`
```
require 'spec_helper'

describe port(3389) do
  it do 
   should be_listening.with('tcp') 
   should be_listening.with('udp') 
  end
end


describe file('c:/windows') do
  it { should be_directory }
end
```

The results are nicely formatted in a standalone HTML report:

![resultt](https://raw.githubusercontent.com/sergueik/puppetmaster_vagrant/master/uru/screenshots/result.png)

and json:
```
{
    "version": "3.5.0.beta4",
    "examples": [{
        "description": "should be directory",
        "full_description": "File \"c:/windows\" should be directory",
        "status": "passed",
        "file_path": "./spec/local/windows_spec.rb",
        "line_number": 4,
        "run_time": 0.470411,
        "pending_message": null
    }, {
        "description": "should be file",
        "full_description": "File \"c:/test\" should be file",
        "status": "failed",
        "file_path": "./spec/local/windows_spec.rb",
        "line_number": 8,
        "run_time": 0.545683,
        "pending_message": null,
        "exception": {
            "class": "RSpec::Expectations::ExpectationNotMetError",
            "message": "expected `File \"c:/test\".file?` to return true, got false",
            "backtrace": ["c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-support-3.5.0.beta4/lib/rspec/support.rb:87:in `block in <module:Support>'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-support-3.5.0.beta4/lib/rspec/support.rb:96:in `call'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-support-3.5.0.beta4/lib/rspec/support.rb:96:in `notify_failure'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-expectations-3.5.0.beta4/lib/rspec/expectations/fail_with.rb:27:in `fail_with'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-expectations-3.5.0.beta4/lib/rspec/expectations/handler.rb:40:in `handle_failure'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-expectations-3.5.0.beta4/lib/rspec/expectations/handler.rb:50:in `block in handle_matcher'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-expectations-3.5.0.beta4/lib/rspec/expectations/handler.rb:27:in `with_matcher'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-expectations-3.5.0.beta4/lib/rspec/expectations/handler.rb:48:in `handle_matcher'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/memoized_helpers.rb:81:in `should'", "C:/uru/spec/local/windows_spec.rb:8:in `block (2 levels) in <top (required)>'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/example.rb:252:in `instance_exec'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/example.rb:252:in `block in run'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/example.rb:494:in `block in with_around_and_singleton_context_hooks'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/example.rb:451:in `block in with_around_example_hooks'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/hooks.rb:471:in `block in run'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/hooks.rb:609:in `run_around_example_hooks_for'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/hooks.rb:471:in `run'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/example.rb:451:in `with_around_example_hooks'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/example.rb:494:in `with_around_and_singleton_context_hooks'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/example.rb:249:in `run'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/example_group.rb:613:in `block in run_examples'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/example_group.rb:609:in `map'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/example_group.rb:609:in `run_examples'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/example_group.rb:575:in `run'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/runner.rb:119:in `block (3 levels) in run_specs'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/runner.rb:119:in `map'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/runner.rb:119:in `block (2 levels) in run_specs'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/configuration.rb:1837:in `with_suite_hooks'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/runner.rb:118:in `block in run_specs'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/reporter.rb:77:in `report'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/runner.rb:117:in `run_specs'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/runner.rb:93:in `run'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/runner.rb:78:in `run'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/lib/rspec/core/runner.rb:45:in `invoke'", "c:/uru/ruby/lib/ruby/gems/2.1.0/gems/rspec-core-3.5.0.beta4/exe/rspec:4:in `<main>'"]
        }
    }],
    "summary": {
        "duration": 1.054691,
        "example_count": 2,
        "failure_count": 1,
        "pending_count": 0
    },
    "summary_line": "2 examples, 1 failure"
}
```

One still has to implement some tool to parse the json and determine what happened (work in progress).
The simplest solution is to print the summary node to stdout where it will be captured in `cloud-init.log`. 



Author
------
[Serguei Kouzmine](kouzmine_serguei@yahoo.com)
